trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # UPDATE these two values to match your setup
  serviceConnection: 'Azure-Lab-Connection' 
  resourceGroupName: 'rg-governance-lab'
  location: 'eastus' # Or your preferred region

stages:
- stage: Validate
  displayName: 'Governance Check'
  jobs:
  - job: PolicyValidation
    displayName: 'Validate Bicep against Azure Policy'
    steps:
    - task: AzureCLI@2
      displayName: 'Run What-If Validation'
      inputs:
        azureSubscription: $(serviceConnection)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Starting Pre-flight validation for $(resourceGroupName)..."
          
          # The 'what-if' command triggers the Azure Policy evaluation engine
          az deployment group what-if \
            --resource-group $(resourceGroupName) \
            --template-file ./keyvault.bicep \
            --parameters location=$(location) \
            --result-format FullResourcePayloads